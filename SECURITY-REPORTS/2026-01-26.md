# üîí Relat√≥rio de Seguran√ßa - Magic3T

**Data da An√°lise:** 28 de Janeiro de 2026
**Vers√£o:** 2.0.1
**Analista:** GitHub Copilot

---

## Sum√°rio Executivo

Ap√≥s an√°lise da base de c√≥digo do projeto Magic3T, foram identificadas **12 vulnerabilidades de seguran√ßa** de diferentes n√≠veis de criticidade. O projeto apresenta boa arquitetura geral com uso de Firebase Auth e valida√ß√£o de entrada, mas possui algumas √°reas que precisam de aten√ß√£o.

---

## Vulnerabilidades Identificadas

### 1. üî¥ **CORS Configurado de Forma Excessivamente Permissiva**

| Atributo | Descri√ß√£o |
|----------|-----------|
| **Criticidade** | **ALTA** |
| **OWASP Category** | A02:2025 - Security Misconfiguration |
| **Facilidade de Explora√ß√£o** | F√°cil |
| **Impacto** | M√©dio-Alto |

**Localiza√ß√£o:**
- `backend/src/main.ts:17` - `app.enableCors()` - CORS habilitado sem restri√ß√µes
- `backend/src/app.gateway.ts:9` - `@WebSocketGateway({ cors: '*' })`
- `backend/src/match/match.gateway.ts:28` - `@WebSocketGateway({ cors: '*', namespace: 'match' })`
- `backend/src/queue/queue.gateway.ts:21` - `@WebSocketGateway({ cors: '*', namespace: 'queue' })`

**Descri√ß√£o:** O CORS est√° configurado para aceitar requisi√ß√µes de qualquer origem (`*`), o que permite que qualquer site malicioso fa√ßa requisi√ß√µes √† API em nome de um usu√°rio autenticado.

**Corre√ß√£o Sugerida:**
```typescript
// main.ts
app.enableCors({
  origin: [
    'https://magic3t.com.br',
    'https://www.magic3t.com.br',
    process.env.NODE_ENV === 'development' && 'http://localhost:5173'
  ].filter(Boolean),
  credentials: true,
})

// WebSocket gateways
@WebSocketGateway({
  cors: {
    origin: ['https://magic3t.com.br', 'https://www.magic3t.com.br'],
    credentials: true
  },
  namespace: 'match'
})
```

---

### 2. üî¥ **Chave de API Firebase Exposta no C√≥digo-Fonte**

| Atributo | Descri√ß√£o |
|----------|-----------|
| **Criticidade** | **ALTA** |
| **OWASP Category** | A02:2025 - Security Misconfiguration |
| **Facilidade de Explora√ß√£o** | Muito F√°cil |
| **Impacto** | M√©dio |

**Localiza√ß√£o:** `frontend/src/services/firebase.ts:6-13`

**Descri√ß√£o:** As credenciais do Firebase est√£o hardcoded diretamente no c√≥digo-fonte:
```typescript
const firebaseConfig = {
  apiKey: 'AIzaSyCl-xdRRlw2sCTGw_s-FcK4aHrsKm_PPdY',
  authDomain: 'kw-magic3t.firebaseapp.com',
  // ...
}
```

Embora a API key do Firebase para o cliente seja projetada para ser p√∫blica (com regras de seguran√ßa no Firebase), √© uma m√° pr√°tica incluir credenciais diretamente no c√≥digo.

**Corre√ß√£o Sugerida:**
```typescript
const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.VITE_FIREBASE_APP_ID,
}
```

---

### 3. üü† **Falta de Valida√ß√£o no Registro de Usu√°rio**

| Atributo | Descri√ß√£o |
|----------|-----------|
| **Criticidade** | **M√âDIA** |
| **OWASP Category** | A05:2025 - Injection / A03:2025 - Software Supply Chain Failures |
| **Facilidade de Explora√ß√£o** | F√°cil |
| **Impacto** | M√©dio |

**Localiza√ß√£o:** `backend/src/user/swagger/user-commands.ts:5-11`

**Descri√ß√£o:** A classe `RegisterUserCommandClass` n√£o possui validadores, diferente de `ChangeNickCommandClass`:

```typescript
export class RegisterUserCommandClass implements RegisterUserCommand {
  @ApiProperty({...})
  nickname: string  // SEM valida√ß√£o!
}

// Comparar com:
export class ChangeNickCommandClass implements ChangeNicknameCommand {
  @IsDefined()
  @IsString()
  @MinLength(3)
  @MaxLength(16)
  @Matches(/^[a-zA-Z0-9√°√Å√¢√Ç...]*$/)
  nickname: string
}
```

**Corre√ß√£o Sugerida:**
```typescript
export class RegisterUserCommandClass implements RegisterUserCommand {
  @ApiProperty({
    type: 'string',
    description: 'The user nickname',
  })
  @IsDefined()
  @IsString()
  @MinLength(3)
  @MaxLength(16)
  @Matches(/^[a-zA-Z0-9√°√Å√¢√Ç√£√É√†√Ä√§√Ñ√©√â√™√ä√®√à√´√ã√≠√ç√Æ√é√¨√å√Ø√è√≥√ì√¥√î√µ√ï√≤√í√∂√ñ√∫√ö√ª√õ√π√ô√º√ú√ß√á√±√ë\s]*$/)
  nickname: string
}
```

---

### 4. üü† **Falta de Headers de Seguran√ßa (Helmet)**

| Atributo | Descri√ß√£o |
|----------|-----------|
| **Criticidade** | **M√âDIA** |
| **OWASP Category** | A02:2025 - Security Misconfiguration |
| **Facilidade de Explora√ß√£o** | M√©dia |
| **Impacto** | M√©dio |

**Localiza√ß√£o:** `backend/src/main.ts`

**Descri√ß√£o:** O backend n√£o utiliza o Helmet ou headers de seguran√ßa HTTP importantes como:
- `X-Content-Type-Options`
- `X-Frame-Options`
- `Strict-Transport-Security`
- `Content-Security-Policy`
- `X-XSS-Protection`

**Corre√ß√£o Sugerida:**
```bash
npm install helmet
```

```typescript
// main.ts
import helmet from 'helmet'

async function bootstrap() {
  const app = await NestFactory.create(AppModule)
  app.use(helmet())
  // ...
}
```

---

### 5. üü† **Rate Limiting N√£o Aplicado a WebSockets**

| Atributo | Descri√ß√£o |
|----------|-----------|
| **Criticidade** | **M√âDIA** |
| **OWASP Category** | A02:2025 - Security Misconfiguration |
| **Facilidade de Explora√ß√£o** | F√°cil |
| **Impacto** | M√©dio |

**Localiza√ß√£o:**
- `backend/src/match/match.gateway.ts`
- `backend/src/queue/queue.gateway.ts`
- `backend/src/app.gateway.ts`

**Descri√ß√£o:** O ThrottlerGuard est√° configurado para HTTP em `backend/src/app.module.ts:20-30`, mas n√£o h√° prote√ß√£o contra abuso nos WebSocket gateways. Um atacante pode enviar milhares de mensagens WebSocket sem restri√ß√£o.

**Corre√ß√£o Sugerida:**
```typescript
// Implementar rate limiting customizado para WebSockets
@Injectable()
export class WsThrottlerGuard extends ThrottlerGuard {
  async handleRequest(context: ExecutionContext, limit: number, ttl: number): Promise<boolean> {
    const client = context.switchToWs().getClient()
    const ip = client.handshake.address
    // Implementar l√≥gica de rate limiting por IP/userId
    return true
  }
}
```

---

### 6. üü† **Mensagens WebSocket Sem Sanitiza√ß√£o**

| Atributo | Descri√ß√£o |
|----------|-----------|
| **Criticidade** | **M√âDIA** |
| **OWASP Category** | A05:2025 - Injection |
| **Facilidade de Explora√ß√£o** | F√°cil |
| **Impacto** | M√©dio |

**Localiza√ß√£o:** `backend/src/match/match.gateway.ts:51-65`

**Descri√ß√£o:** As mensagens de chat s√£o retransmitidas sem valida√ß√£o de tamanho ou conte√∫do:

```typescript
@SubscribeMessage(MatchClientEvents.Message)
handleMessage(@UserId() uid: string, @MessageBody() body: string) {
  const messageData: MessagePayload = {
    message: body,  // Nenhuma valida√ß√£o!
    sender: uid,
    time: Date.now(),
  }
  this.socketsService.send(opponent, MatchServerEvents.Message, messageData)
}
```

**Corre√ß√£o Sugerida:**
```typescript
@SubscribeMessage(MatchClientEvents.Message)
handleMessage(@UserId() uid: string, @MessageBody() body: string) {
  // Validar tamanho
  if (!body || typeof body !== 'string' || body.length > 500) {
    return
  }

  // Sanitizar conte√∫do (remover scripts, etc)
  const sanitizedMessage = body.trim().slice(0, 500)

  const messageData: MessagePayload = {
    message: sanitizedMessage,
    sender: uid,
    time: Date.now(),
  }
  // ...
}
```

---

### 7. üü° **Falta de Valida√ß√£o de `iconId` Range**

| Atributo | Descri√ß√£o |
|----------|-----------|
| **Criticidade** | **BAIXA** |
| **OWASP Category** | A01:2025 - Broken Access Control |
| **Facilidade de Explora√ß√£o** | F√°cil |
| **Impacto** | Baixo |

**Localiza√ß√£o:** `backend/src/user/swagger/user-commands.ts:26-31`

**Descri√ß√£o:** O `iconId` √© validado como n√∫mero, mas sem range. N√∫meros negativos ou muito grandes poderiam ser aceitos:

```typescript
export class ChangeIconCommandClass implements ChangeIconCommand {
  @ApiProperty()
  @IsNumber()
  @IsDefined()
  iconId: number  // Sem @Min/@Max
}
```

**Corre√ß√£o Sugerida:**
```typescript
import { Min, Max } from 'class-validator'

export class ChangeIconCommandClass implements ChangeIconCommand {
  @ApiProperty()
  @IsNumber()
  @IsDefined()
  @Min(0)
  @Max(1000)  // Ajustar conforme range v√°lido
  iconId: number
}
```

---

### 8. üü° **Logs Excessivos em Produ√ß√£o**

| Atributo | Descri√ß√£o |
|----------|-----------|
| **Criticidade** | **BAIXA** |
| **OWASP Category** | A09:2025 - Security Logging and Alerting Failures |
| **Facilidade de Explora√ß√£o** | N/A |
| **Impacto** | Baixo |

**Localiza√ß√£o:** V√°rios arquivos, especialmente:
- `frontend/src/main.tsx:25` - `console.log('Auth state changed:', user)`

**Descri√ß√£o:** Existem v√°rios `console.log` no frontend que exp√µem informa√ß√µes sobre o estado da autentica√ß√£o e podem vazar dados sens√≠veis no console do navegador.

**Corre√ß√£o Sugerida:**
```typescript
// Usar logging condicional
if (import.meta.env.DEV) {
  console.log('Auth state changed:', user)
}

// Ou usar o sistema Console j√° existente com n√≠veis de log
Console.debug('Auth state changed:', user)
```

---

### 9. üü° **Falta de Valida√ß√£o de Tipo em `QUEUE_STATUS_POLLING_RATE`**

| Atributo | Descri√ß√£o |
|----------|-----------|
| **Criticidade** | **BAIXA** |
| **OWASP Category** | A02:2025 - Security Misconfiguration |
| **Facilidade de Explora√ß√£o** | Dif√≠cil |
| **Impacto** | Baixo |

**Localiza√ß√£o:** `backend/src/queue/queue.gateway.ts:47`

**Descri√ß√£o:** A vari√°vel de ambiente √© usada sem valida√ß√£o de tipo:
```typescript
}, process.env.QUEUE_STATUS_POLLING_RATE || 2000)
```

Se algu√©m configurar um valor n√£o num√©rico, pode causar comportamento inesperado.

**Corre√ß√£o Sugerida:**
```typescript
const pollingRate = Number(process.env.QUEUE_STATUS_POLLING_RATE) || 2000
if (pollingRate < 1000 || pollingRate > 60000) {
  throw new Error('Invalid QUEUE_STATUS_POLLING_RATE')
}
setInterval(() => { ... }, pollingRate)
```

---

### 10. üü° **Potencial Enumera√ß√£o de Usu√°rios**

| Atributo | Descri√ß√£o |
|----------|-----------|
| **Criticidade** | **BAIXA** |
| **OWASP Category** | A07:2025 - Authentication Failures |
| **Facilidade de Explora√ß√£o** | F√°cil |
| **Impacto** | Baixo |

**Localiza√ß√£o:**
- `backend/src/user/user.controller.ts:45-49`
- `backend/src/user/user.controller.ts:33-37`

**Descri√ß√£o:** Os endpoints `/users/id/:id` e `/users/nickname/:nickname` retornam erros diferentes (404) que permitem enumerar usu√°rios existentes.

**Corre√ß√£o Sugerida:**
Para aplica√ß√µes mais sens√≠veis, considerar:
1. Adicionar rate limiting espec√≠fico nesses endpoints
2. Implementar delay artificial nas respostas
3. Para casos extremos, retornar dados gen√©ricos mesmo quando usu√°rio n√£o existe

---

### 11. üü¢ **Docker Container Rodando com `USER node`** ‚úÖ

**Status:** BEM IMPLEMENTADO

**Localiza√ß√£o:** `Dockerfile.backend:11`

O Dockerfile j√° implementa a melhor pr√°tica de rodar o container com usu√°rio n√£o-root.

---

### 12. üü¢ **Rate Limiting HTTP Implementado** ‚úÖ

**Status:** BEM IMPLEMENTADO

**Localiza√ß√£o:** `backend/src/app.module.ts:20-30`

O ThrottlerModule est√° configurado com limites razo√°veis para requisi√ß√µes HTTP.

---

## Resumo de Criticidade

| N√≠vel | Quantidade | Vulnerabilidades |
|-------|------------|------------------|
| üî¥ ALTA | 2 | CORS Permissivo, Credenciais Expostas |
| üü† M√âDIA | 4 | Valida√ß√£o Register, Helmet, WS Rate Limit, Mensagens n√£o sanitizadas |
| üü° BAIXA | 4 | IconId Range, Logs, Env Validation, User Enumeration |
| üü¢ OK | 2 | Docker user, HTTP Rate Limit |

---

## Recomenda√ß√µes Priorit√°rias

1. **IMEDIATO:** Configurar CORS com origens espec√≠ficas
2. **IMEDIATO:** Mover credenciais Firebase para vari√°veis de ambiente
3. **CURTO PRAZO:** Adicionar Helmet para headers de seguran√ßa
4. **CURTO PRAZO:** Implementar valida√ß√£o no `RegisterUserCommandClass`
5. **M√âDIO PRAZO:** Implementar rate limiting para WebSockets
6. **M√âDIO PRAZO:** Sanitizar mensagens de chat

---

## Considera√ß√µes Adicionais

### Pontos Positivos:
- ‚úÖ Uso do Firebase Auth com valida√ß√£o de tokens no backend
- ‚úÖ Guards de autentica√ß√£o bem implementados (`AuthGuard`, `MatchGuard`, `AdminGuard`)
- ‚úÖ Uso de `ValidationPipe` global para valida√ß√£o de DTOs
- ‚úÖ Tratamento centralizado de erros com filters
- ‚úÖ Firestore com acesso via SDK Admin (regras server-side)
- ‚úÖ Rate limiting HTTP configurado
- ‚úÖ Container Docker n√£o roda como root

### √Åreas para Monitoramento:
- Manter depend√™ncias atualizadas (`npm audit`)
- Implementar logging de seguran√ßa para eventos cr√≠ticos
- Considerar implementar CSP headers no frontend

---

## Refer√™ncias

- [OWASP Top 10:2025](https://owasp.org/Top10/2025/)
- [NestJS Security Best Practices](https://docs.nestjs.com/security/helmet)
- [Firebase Security Rules](https://firebase.google.com/docs/rules)
